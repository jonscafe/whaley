<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whaley - Admin Dashboard</title>
    <link rel="icon" type="image/png" href="/static/icon.png">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        /* Navigation Tabs */
        .admin-nav {
            display: flex;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--accent-primary);
            color: white;
        }

        .nav-tab .tab-icon {
            font-size: 1.1rem;
        }

        .tab-page {
            display: none;
        }

        .tab-page.active {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        .sub-tabs {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 12px;
        }

        .sub-tab {
            transition: all 0.2s ease;
        }

        .sub-tab.active {
            background: var(--primary-color) !important;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .admin-header h2 {
            margin: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-mono);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .log-filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .log-filters select,
        .log-filters input {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .log-filters select:focus,
        .log-filters input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .pagination-container {
            margin-top: 12px;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .pagination-info {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .logs-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .logs-table th,
        .logs-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .logs-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }

        .logs-table tr:hover td {
            background: var(--bg-card-hover);
        }

        .log-event {
            display: inline-block;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .event-instance_spawn {
            background: #10b98120;
            color: #34d399;
        }

        .event-instance_spawn_failed {
            background: #ef444420;
            color: #f87171;
        }

        .event-instance_stop {
            background: #f59e0b20;
            color: #fbbf24;
        }

        .event-instance_extend {
            background: #3b82f620;
            color: #60a5fa;
        }

        .event-instance_expired {
            background: #8b5cf620;
            color: #a78bfa;
        }

        .event-user_login {
            background: #10b98120;
            color: #34d399;
        }

        .event-user_login_failed {
            background: #ef444420;
            color: #f87171;
        }

        .event-system_start {
            background: #6366f120;
            color: #818cf8;
        }

        .event-system_stop {
            background: #64748b20;
            color: #94a3b8;
        }

        .log-time {
            font-family: var(--font-mono);
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .log-user {
            font-weight: 500;
        }

        .log-message {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .log-ports {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--accent-info);
        }

        .log-url {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--accent-success);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .pagination .page-info {
            color: var(--text-muted);
            font-size: 0.85rem;
            padding: 0 12px;
        }

        .back-link {
            color: var(--accent-primary);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: .3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-muted);
            transition: .3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: var(--accent-success);
            border-color: var(--accent-success);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(20px);
            background-color: white;
        }

        /* Forensics type badges */
        .forensics-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .forensics-type.auto {
            background: #8b5cf620;
            color: #a78bfa;
        }

        .forensics-type.live {
            background: #10b98120;
            color: #34d399;
        }

        .forensics-reason {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Monitoring metric badges */
        .forensics-type.success {
            background: #10b98120;
            color: #34d399;
        }

        .forensics-type.warning {
            background: #f59e0b20;
            color: #fbbf24;
        }

        .forensics-type.danger {
            background: #ef444420;
            color: #f87171;
        }

        .instances-section {
            margin-top: 0;
        }

        .instance-admin-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 16px;
            align-items: center;
        }

        .instance-admin-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .instance-admin-header {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .instance-admin-details {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .refresh-indicator {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Challenge Manager Styles */
        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--accent-primary);
            background: var(--bg-secondary);
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        .challenges-list-admin {
            display: grid;
            gap: 12px;
        }

        .challenge-admin-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 16px;
            align-items: center;
        }

        .challenge-admin-card.selected {
            border-color: var(--accent-primary);
            background: var(--accent-primary)10;
        }

        .file-browser {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 16px;
            margin-top: 16px;
            min-height: 400px;
        }

        .file-tree {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 12px;
            overflow: auto;
            max-height: 500px;
        }

        .file-tree-item {
            padding: 6px 8px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .file-tree-item:hover {
            background: var(--bg-card-hover);
        }

        .file-tree-item.selected {
            background: var(--accent-primary)20;
            color: var(--accent-primary);
        }

        .file-tree-item .icon {
            width: 16px;
            text-align: center;
        }

        .file-tree-children {
            margin-left: 20px;
        }

        .file-editor-container {
            display: flex;
            flex-direction: column;
        }

        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .editor-path {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .file-editor {
            width: 100%;
            min-height: 350px;
            padding: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.5;
            resize: vertical;
        }

        .file-editor:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .editor-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 350px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-muted);
        }

        .new-file-form {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .new-file-form input {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }

        @media (max-width: 900px) {
            .file-browser {
                grid-template-columns: 1fr;
            }

            .file-tree {
                max-height: 200px;
            }

            .admin-nav {
                flex-direction: column;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .sync-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .sync-filters input,
        .sync-filters select {
            padding: 8px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .sync-filters input {
            flex: 1;
            min-width: 200px;
        }

        .ctfd-challenge-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .ctfd-challenge-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            background: var(--bg-primary);
        }

        .ctfd-challenge-item:hover {
            border-color: var(--accent-primary);
        }

        .ctfd-challenge-item.mapped {
            opacity: 0.6;
            background: rgba(16, 185, 129, 0.1);
        }

        .ctfd-challenge-item.suggested {
            border-color: var(--accent-warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .ctfd-challenge-info {
            flex: 1;
        }

        .ctfd-challenge-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .ctfd-challenge-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .ctfd-challenge-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            background: var(--accent-primary);
            color: white;
        }

        .ctfd-challenge-badge.warning {
            background: var(--accent-warning);
        }

        .ctfd-challenge-badge.success {
            background: var(--accent-success);
        }

        .sync-action-select {
            min-width: 150px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">üîß</span>
                <h1>Whaley Admin Dashboard</h1>
            </div>
            <div class="status-bar">
                <a href="/" class="back-link">‚Üê Back to Instancer</a>
            </div>
        </header>

        <!-- Admin Auth Section -->
        <section class="card auth-card" id="admin-auth-section">
            <div class="card-header">
                <h2>üîê Admin Authentication</h2>
            </div>
            <div class="card-body">
                <p class="auth-description">Enter the admin secret key to access the dashboard.</p>
                <div class="auth-form">
                    <div class="input-group">
                        <label for="admin-key">Admin Secret Key</label>
                        <input type="password" id="admin-key" placeholder="Enter admin key..." autocomplete="off"
                            onkeypress="if(event.key==='Enter')adminLogin()">
                    </div>
                    <button class="btn btn-primary" onclick="adminLogin()">
                        <span class="btn-icon">üîë</span> Access Dashboard
                    </button>
                </div>
            </div>
        </section>

        <!-- Main Admin Content -->
        <main class="main-content hidden" id="admin-content">
            <!-- Navigation Tabs -->
            <nav class="admin-nav">
                <button class="nav-tab active" data-page="dashboard" onclick="switchPage('dashboard')">
                    <span class="tab-icon">üìä</span>
                    <span>Dashboard</span>
                </button>
                <button class="nav-tab" data-page="logs" onclick="switchPage('logs')">
                    <span class="tab-icon">üìú</span>
                    <span>Whaley Logs</span>
                </button>
                <button class="nav-tab" data-page="flags" onclick="switchPage('flags')">
                    <span class="tab-icon">üö©</span>
                    <span>Dynamic Flags</span>
                </button>
                <button class="nav-tab" data-page="challenges" onclick="switchPage('challenges')">
                    <span class="tab-icon">üì¶</span>
                    <span>Challenge Manager</span>
                </button>
                <button class="nav-tab" data-page="monitoring" onclick="switchPage('monitoring')">
                    <span class="tab-icon">üìà</span>
                    <span>Monitoring</span>
                </button>
            </nav>

            <!-- Page 1: Dashboard -->
            <div class="tab-page active" id="page-dashboard">
                <!-- Stats Section -->
                <section class="card">
                    <div class="card-header">
                        <h2>üìä Statistics</h2>
                        <span class="refresh-indicator" id="last-refresh">Auto-refresh: 30s</span>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid" id="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="stat-total-spawns">0</div>
                                <div class="stat-label">Total Spawns</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-active-instances">0</div>
                                <div class="stat-label">Active Instances</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-unique-users">0</div>
                                <div class="stat-label">Unique Users</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-24h-events">0</div>
                                <div class="stat-label">Events (24h)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-ports-used">0</div>
                                <div class="stat-label">Ports In Use</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-ports-available">0</div>
                                <div class="stat-label">Ports Available</div>
                            </div>
                            <div class="stat-card" id="stat-mode-card">
                                <div class="stat-value" id="stat-mode">-</div>
                                <div class="stat-label">Instance Mode</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Active Instances Section -->
                <section class="card instances-section">
                    <div class="card-header">
                        <h2>üöÄ Active Instances</h2>
                        <button class="btn btn-secondary btn-sm" onclick="loadAllInstances()">
                            <span class="btn-icon">üîÑ</span> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="all-instances-list">
                            <div class="loading">Loading instances...</div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Page 2: Whaley Logs -->
            <div class="tab-page" id="page-logs">
                <!-- Sub-tabs for logs -->
                <div class="sub-tabs" style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button class="btn btn-primary btn-sm sub-tab active" data-subtab="events"
                        onclick="switchLogTab('events')">
                        üìú Event Logs
                    </button>
                    <button class="btn btn-secondary btn-sm sub-tab" data-subtab="ports"
                        onclick="switchLogTab('ports')">
                        üîå User Ports
                    </button>
                    <button class="btn btn-secondary btn-sm sub-tab" data-subtab="forensics"
                        onclick="switchLogTab('forensics')">
                        üîç Instance Forensics
                    </button>
                </div>

                <!-- Event Logs Section -->
                <section class="card log-section" id="section-events">
                    <div class="card-header">
                        <h2>üìú Event Logs</h2>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" onclick="exportLogsJSON()" title="Export as JSON">
                                <span class="btn-icon">üìÑ</span> JSON
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="exportLogsCSV()" title="Export as CSV">
                                <span class="btn-icon">üìä</span> CSV
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="loadLogs()">
                                <span class="btn-icon">üîÑ</span> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="log-filters">
                            <select id="filter-event-type" onchange="currentPage=0; loadLogs()">
                                <option value="">All Events</option>
                                <option value="instance_spawn">Instance Spawn</option>
                                <option value="instance_spawn_failed">Spawn Failed</option>
                                <option value="instance_stop">Instance Stop</option>
                                <option value="instance_extend">Instance Extend</option>
                                <!-- <option value="instance_expired">Instance Expired</option> -->
                                <!-- <option value="user_login">User Login</option> -->
                                <!-- <option value="user_login_failed">Login Failed</option> -->
                                <option value="flag_created">Flag Created</option>
                                <option value="suspicious_submission">Suspicious Submission</option>
                            </select>
                            <input type="text" id="filter-user" placeholder="Filter by username..."
                                onkeyup="debounceLoadLogs()">
                            <select id="filter-limit" onchange="currentPage=0; loadLogs()">
                                <option value="50" selected>50 entries</option>
                                <option value="100">100 entries</option>
                                <option value="200">200 entries</option>
                                <option value="500">500 entries</option>
                            </select>
                        </div>

                        <div class="table-wrapper" style="overflow-x: auto;">
                            <table class="logs-table">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Event</th>
                                        <th>User</th>
                                        <th>Challenge</th>
                                        <th>Ports</th>
                                        <th>URL</th>
                                        <th>IP</th>
                                        <th>Message</th>
                                    </tr>
                                </thead>
                                <tbody id="logs-body">
                                    <tr>
                                        <td colspan="8" class="loading">Loading logs...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="pagination" id="pagination"></div>
                    </div>
                </section>

                <!-- User Ports Section -->
                <section class="card log-section hidden" id="section-ports">
                    <div class="card-header">
                        <h2>üîå User Port Mappings</h2>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-danger btn-sm" onclick="clearAllUserPorts()">
                                <span class="btn-icon">üóëÔ∏è</span> Clear All
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="loadUserPorts()">
                                <span class="btn-icon">üîÑ</span> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--text-muted); margin-bottom: 16px;">
                            Persistent port mappings, reusing the same ports when respawning challenges.
                        </p>

                        <div class="log-filters">
                            <input type="text" id="filter-port-user" placeholder="Filter by user..."
                                onkeyup="filterUserPorts()">
                            <input type="text" id="filter-port-challenge" placeholder="Filter by challenge..."
                                onkeyup="filterUserPorts()">
                        </div>

                        <div class="table-wrapper" style="overflow-x: auto;">
                            <table class="logs-table">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Challenge</th>
                                        <th>Port Mappings</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="user-ports-body">
                                    <tr>
                                        <td colspan="4" class="loading">Loading user ports...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div id="ports-summary" style="margin-top: 16px; color: var(--text-muted); font-size: 0.9rem;">
                        </div>
                    </div>
                </section>

                <!-- Instance Forensics Section -->
                <section class="card log-section hidden" id="section-forensics">
                    <div class="card-header">
                        <h2>üîç Instance Forensics</h2>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <label class="toggle-switch"
                                title="Auto Capture: Automatically log containers on terminate">
                                <input type="checkbox" id="forensics-auto-capture"
                                    onchange="toggleForensicsAutoCapture()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span style="font-size: 0.85rem; color: var(--text-muted);">Auto Capture</span>
                            <button class="btn btn-danger btn-sm" onclick="clearForensicsLogs()"
                                style="margin-left: 16px;">
                                <span class="btn-icon">üóëÔ∏è</span> Clear All
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="loadForensicsLogs()">
                                <span class="btn-icon">üîÑ</span> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Forensics Stats -->
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-value" id="stat-forensics-status">OFF</div>
                                <div class="stat-label">Auto Capture</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-forensics-total">0</div>
                                <div class="stat-label">Total Logs</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-forensics-auto">0</div>
                                <div class="stat-label">Auto Captured</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-forensics-live">0</div>
                                <div class="stat-label">Live Captured</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-forensics-size">0 MB</div>
                                <div class="stat-label">Total Size</div>
                            </div>
                        </div>

                        <!-- Live Capture Section -->
                        <div
                            style="background: var(--bg-secondary); border-radius: var(--radius-md); padding: 16px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                            <h3 style="margin: 0 0 12px 0; font-size: 1rem;">üì∏ Live Capture (On-Demand)</h3>
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;">
                                Capture logs from a running instance without stopping it. Useful for debugging.
                            </p>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <select id="forensics-live-instance"
                                    style="flex: 1; padding: 8px 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary);">
                                    <option value="">-- Select Running Instance --</option>
                                </select>
                                <button class="btn btn-primary btn-sm" onclick="doLiveCapture()">
                                    <span class="btn-icon">üì∏</span> Capture Now
                                </button>
                            </div>
                        </div>

                        <!-- Info Box -->
                        <div
                            style="background: rgba(59, 130, 246, 0.1); border-radius: var(--radius-sm); padding: 12px; margin-bottom: 16px; border-left: 3px solid var(--accent-info);">
                            <strong style="color: var(--accent-info);">‚ÑπÔ∏è About Instance Forensics</strong>
                            <ul
                                style="margin: 8px 0 0 0; padding-left: 20px; color: var(--text-secondary); font-size: 0.85rem;">
                                <li><strong>Auto Capture:</strong> Automatically dump container logs when instances
                                    terminate (stopped/expired)</li>
                                <li><strong>Live Capture:</strong> On-demand log capture from running containers without
                                    stopping them</li>
                                <li>Logs are compressed and auto-deleted after retention period</li>
                                <li>‚ö†Ô∏è Auto Capture may impact server resources - see documentation for sizing</li>
                            </ul>
                        </div>

                        <!-- Filters -->
                        <div class="log-filters">
                            <select id="filter-forensics-type" onchange="filterForensicsLogs()">
                                <option value="">All Captures</option>
                                <option value="auto">Auto Capture Only</option>
                                <option value="live">Live Capture Only</option>
                            </select>
                            <input type="text" id="filter-forensics-challenge" placeholder="Filter by challenge..."
                                onkeyup="filterForensicsLogs()">
                            <input type="text" id="filter-forensics-owner" placeholder="Filter by owner/spawner..."
                                onkeyup="filterForensicsLogs()">
                        </div>

                        <div class="table-wrapper" style="overflow-x: auto;">
                            <table class="logs-table">
                                <thead>
                                    <tr>
                                        <th>Capture Time</th>
                                        <th>Type</th>
                                        <th>Challenge</th>
                                        <th>Containers</th>
                                        <th>Owner</th>
                                        <th>Spawned By</th>
                                        <th>Reason</th>
                                        <th>Size</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="forensics-logs-body">
                                    <tr>
                                        <td colspan="9" class="loading">Loading forensics logs...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div id="pagination-forensics" class="pagination-container"></div>
                    </div>
                </section>
            </div>

            <!-- Page 3: Dynamic Flags -->
            <div class="tab-page" id="page-flags">
                <!-- Status Banner -->
                <section class="card" id="flags-status-card">
                    <div class="card-header">
                        <h2>üö© Dynamic Flags Status</h2>
                        <button class="btn btn-secondary btn-sm" onclick="loadFlagsData()">
                            <span class="btn-icon">üîÑ</span> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid" id="flags-stats">
                            <div class="stat-card">
                                <div class="stat-value" id="stat-flags-enabled">-</div>
                                <div class="stat-label">Status</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-total-flags">0</div>
                                <div class="stat-label">Total Dynamic Flags</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-flags-users">0</div>
                                <div class="stat-label">Users with Flags</div>
                            </div>
                            <div class="stat-card" style="border-color: var(--accent-danger);">
                                <div class="stat-value" id="stat-suspicious" style="color: var(--accent-danger);">0
                                </div>
                                <div class="stat-label">Suspicious Submissions</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Suspicious Submissions -->
                <section class="card">
                    <div class="card-header">
                        <h2>‚ö†Ô∏è Suspicious Submissions</h2>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary btn-sm" onclick="checkSubmissions()">
                                <span class="btn-icon">üîç</span> Check Now
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="clearSuspicious()">
                                <span class="btn-icon">üóëÔ∏è</span> Clear
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--text-muted); margin-bottom: 16px;">
                            Shows users who submitted flags belonging to other users (automatically refreshes every
                            60s).
                        </p>
                        <div class="table-wrapper" style="overflow-x: auto;">
                            <table class="logs-table">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Submitter</th>
                                        <th>Flag Owner</th>
                                        <th>Challenge</th>
                                        <th>IP Address</th>
                                    </tr>
                                </thead>
                                <tbody id="suspicious-body">
                                    <tr>
                                        <td colspan="5" class="empty-state">No suspicious submissions</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="pagination-suspicious" class="pagination-container"></div>
                    </div>
                </section>

                <!-- Flag Mappings -->
                <section class="card">
                    <div class="card-header">
                        <h2>üîê Flag Mappings</h2>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--text-muted); margin-bottom: 16px;">
                            Each user gets a unique flag per challenge. These flags are registered with CTFd.
                        </p>

                        <div class="log-filters">
                            <input type="text" id="filter-flag-user" placeholder="Filter by user..."
                                onkeyup="filterFlagMappings()">
                            <input type="text" id="filter-flag-challenge" placeholder="Filter by challenge..."
                                onkeyup="filterFlagMappings()">
                        </div>

                        <div class="table-wrapper" style="overflow-x: auto;">
                            <table class="logs-table">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Challenge</th>
                                        <th>Flag (truncated)</th>
                                        <th>Created</th>
                                        <th style="width: 80px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="flag-mappings-body">
                                    <tr>
                                        <td colspan="5" class="loading">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="pagination-flag-mappings" class="pagination-container"></div>
                    </div>
                </section>

                <!-- Challenge Mapping -->
                <section class="card">
                    <div class="card-header">
                        <h2>üîó Challenge ID Mapping</h2>
                        <button class="btn btn-primary btn-sm" onclick="openSyncWizard()">
                            <span class="btn-icon">üîÑ</span> Sync Wizard
                        </button>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--text-muted); margin-bottom: 16px;">
                            Maps local challenge IDs to CTFd challenge IDs for dynamic flag registration.
                        </p>

                        <!-- Manual Add Mapping Form -->
                        <details style="margin-bottom: 20px;">
                            <summary style="cursor: pointer; color: var(--text-muted); font-size: 0.9rem;">
                                ‚ûï Manual Mapping (advanced)
                            </summary>
                            <div
                                style="display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; align-items: flex-end; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-sm);">
                                <div style="flex: 1; min-width: 200px;">
                                    <label
                                        style="display: block; margin-bottom: 4px; font-size: 0.85rem; color: var(--text-muted);">Local
                                        Challenge</label>
                                    <select id="mapping-local-id"
                                        style="width: 100%; padding: 8px 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary);">
                                        <option value="">-- Select Challenge --</option>
                                    </select>
                                </div>
                                <div style="flex: 1; min-width: 150px;">
                                    <label
                                        style="display: block; margin-bottom: 4px; font-size: 0.85rem; color: var(--text-muted);">CTFd
                                        Challenge ID</label>
                                    <input type="number" id="mapping-ctfd-id" placeholder="e.g., 42" min="1"
                                        style="width: 100%; padding: 8px 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary);">
                                </div>
                                <button class="btn btn-primary" onclick="addChallengeMapping()">
                                    <span class="btn-icon">‚ûï</span> Add
                                </button>
                            </div>
                        </details>

                        <!-- Mapping List -->
                        <div class="table-wrapper" style="overflow-x: auto;">
                            <table class="logs-table">
                                <thead>
                                    <tr>
                                        <th>Local Challenge ID</th>
                                        <th>CTFd Challenge ID</th>
                                        <th>Status</th>
                                        <th style="width: 100px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="challenge-mapping-body">
                                    <tr>
                                        <td colspan="4" class="loading">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="pagination-challenge-mapping" class="pagination-container"></div>
                    </div>
                </section>
            </div>

            <!-- Page 4: Challenge Manager -->
            <div class="tab-page" id="page-challenges">
                <section class="card">
                    <div class="card-header">
                        <h2>üì¶ Challenge Manager</h2>
                        <button class="btn btn-secondary btn-sm" onclick="loadChallengesList()">
                            <span class="btn-icon">üîÑ</span> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Upload Zone -->
                        <div class="upload-zone" id="upload-zone"
                            onclick="document.getElementById('challenge-file').click()">
                            <input type="file" id="challenge-file" accept=".zip" onchange="uploadChallenge(this)">
                            <p>üìÅ <strong>Click or drag</strong> a .zip file to upload a new challenge</p>
                            <p style="font-size: 0.85rem; color: var(--text-muted);">The zip should contain
                                challenge.yaml and docker-compose.yaml</p>
                        </div>

                        <!-- Challenges List -->
                        <div class="challenges-list-admin" id="challenges-list-admin">
                            <div class="loading">Loading challenges...</div>
                        </div>

                        <!-- File Browser (shown when challenge selected) -->
                        <div id="file-browser-section" class="hidden">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0 12px;">
                                <h3 style="margin: 0;">üìù File Editor: <span id="selected-challenge-name"></span></h3>
                                <button class="btn btn-secondary btn-sm" onclick="closeFileEditor()">
                                    ‚úï Close
                                </button>
                            </div>

                            <div class="new-file-form">
                                <input type="text" id="new-file-path" placeholder="path/to/new-file.txt">
                                <button class="btn btn-secondary btn-sm" onclick="createNewFile()">
                                    <span class="btn-icon">‚ûï</span> New File
                                </button>
                            </div>

                            <div class="file-browser">
                                <div class="file-tree" id="file-tree">
                                    <div class="loading">Loading files...</div>
                                </div>
                                <div class="file-editor-container" id="editor-container">
                                    <div class="editor-placeholder">
                                        <p>‚Üê Select a file to edit</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Page 5: Monitoring -->
            <div class="tab-page" id="page-monitoring">
                <!-- System Overview -->
                <section class="card">
                    <div class="card-header">
                        <h2>üìä System Overview</h2>
                        <button class="btn btn-primary" onclick="refreshMonitoring()">üîÑ Refresh</button>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Total Containers</div>
                                <div class="stat-value" id="stat-total-containers">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Running Containers</div>
                                <div class="stat-value" id="stat-running-containers">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total CPU Usage</div>
                                <div class="stat-value" id="stat-total-cpu">-</div>
                                <div class="stat-meta" id="stat-cpu-cores">- cores available</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Memory Usage</div>
                                <div class="stat-value" id="stat-total-memory">-</div>
                                <div class="stat-meta" id="stat-host-memory">- / - MB</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Instance Resource Usage -->
                <section class="card">
                    <div class="card-header">
                        <h2>üîç Instance Resource Usage</h2>
                        <div class="header-actions">
                            <label>
                                <input type="checkbox" id="filter-high-usage" onchange="filterMonitoringInstances()">
                                Show high usage only (CPU >50% or RAM >80%)
                            </label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="monitoring-instances-container">
                            <p style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                Loading instance metrics...
                            </p>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>üîß Whaley Admin</p>
            <p class="footer-credit">Made with ‚ù§Ô∏è by <a href="https://github.com/jonscafe" target="_blank"
                    rel="noopener">keii</a></p>
        </footer>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        let adminKey = null;
        let currentPage = 0;
        let currentTab = 'dashboard';
        let debounceTimer = null;
        let selectedChallenge = null;
        let selectedFile = null;
        let unsavedChanges = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            adminKey = localStorage.getItem('admin_key');

            // Check URL hash for page
            const hash = window.location.hash.replace('#', '');
            if (['dashboard', 'logs', 'challenges'].includes(hash)) {
                currentTab = hash;
            }

            if (adminKey) {
                verifyAdminKey();
            }

            // Setup drag and drop for upload zone
            const uploadZone = document.getElementById('upload-zone');
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.endsWith('.zip')) {
                    uploadChallengeFile(files[0]);
                } else {
                    showToast('Please drop a .zip file', 'error');
                }
            });
        });

        function switchPage(page) {
            if (unsavedChanges && !confirm('You have unsaved changes. Discard them?')) {
                return;
            }

            currentTab = page;
            window.location.hash = page;

            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.page === page);
            });

            // Update page visibility
            document.querySelectorAll('.tab-page').forEach(p => {
                p.classList.toggle('active', p.id === `page-${page}`);
            });

            // Load data for the page
            loadPageData(page);
        }

        async function loadPageData(page) {
            switch (page) {
                case 'dashboard':
                    await Promise.all([loadStats(), loadAllInstances()]);
                    break;
                case 'logs':
                    await loadLogs();
                    break;
                case 'flags':
                    await loadFlagsData();
                    break;
                case 'challenges':
                    await loadChallengesList();
                    break;
                case 'monitoring':
                    await loadMonitoringData();
                    break;
            }
        }

        async function adminLogin() {
            const keyInput = document.getElementById('admin-key');
            const key = keyInput.value.trim();

            if (!key) {
                showToast('Please enter admin key', 'error');
                return;
            }

            adminKey = key;
            await verifyAdminKey();
        }

        async function verifyAdminKey() {
            try {
                const response = await fetch('/admin/api/stats', {
                    headers: {
                        'X-Admin-Key': adminKey
                    }
                });

                if (response.ok) {
                    localStorage.setItem('admin_key', adminKey);
                    showAdminContent();

                    // Switch to saved tab and load data
                    switchPage(currentTab);

                    // Auto-refresh current page every 30 seconds
                    setInterval(() => loadPageData(currentTab), 30000);
                } else {
                    adminKey = null;
                    localStorage.removeItem('admin_key');
                    showToast('Invalid admin key', 'error');
                }
            } catch (error) {
                showToast('Failed to verify admin key', 'error');
            }
        }

        function showAdminContent() {
            document.getElementById('admin-auth-section').classList.add('hidden');
            document.getElementById('admin-content').classList.remove('hidden');
        }

        async function adminApi(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'X-Admin-Key': adminKey
                }
            };

            if (body) {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }

            const response = await fetch(endpoint, options);

            if (!response.ok) {
                throw new Error('API Error');
            }

            return response.json();
        }

        async function loadStats() {
            try {
                const [statsData, portData, configData] = await Promise.all([
                    adminApi('/admin/api/stats'),
                    adminApi('/admin/api/port-stats'),
                    fetch('/config').then(r => r.json()).catch(() => ({ team_mode: false }))
                ]);

                document.getElementById('stat-total-spawns').textContent =
                    statsData.event_counts?.instance_spawn || 0;
                document.getElementById('stat-active-instances').textContent =
                    statsData.active_instances || 0;
                document.getElementById('stat-unique-users').textContent =
                    statsData.unique_users || 0;
                document.getElementById('stat-24h-events').textContent =
                    statsData.last_24h_events || 0;

                // Port stats
                document.getElementById('stat-ports-used').textContent =
                    portData.currently_allocated || 0;
                document.getElementById('stat-ports-available').textContent =
                    portData.available || 0;

                // Instance mode
                const modeEl = document.getElementById('stat-mode');
                const modeCardEl = document.getElementById('stat-mode-card');
                if (modeEl) {
                    if (configData.team_mode) {
                        modeEl.textContent = 'üë• Team';
                        modeEl.style.color = 'var(--accent-success)';
                    } else {
                        modeEl.textContent = 'üë§ User';
                        modeEl.style.color = 'var(--accent-primary)';
                    }
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadAllInstances() {
            const container = document.getElementById('all-instances-list');

            try {
                const data = await adminApi('/admin/api/instances');
                const instances = data.instances || [];

                if (instances.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span class="empty-icon">üì¶</span>
                            <p>No active instances</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = instances.map(instance => {
                    const portsStr = Object.entries(instance.ports || {})
                        .map(([i, e]) => `${i}‚Üí${e}`)
                        .join(', ');

                    // Use username if available, fallback to user_id
                    const displayName = instance.username || instance.user_id;

                    return `
                        <div class="instance-admin-card">
                            <div class="instance-admin-info">
                                <div class="instance-admin-header">
                                    <span class="instance-name">${escapeHtml(instance.challenge_id)}</span>
                                    <span class="instance-status status-${instance.status}">${instance.status}</span>
                                    <span class="challenge-category category-web">${instance.instance_id}</span>
                                </div>
                                <div class="instance-admin-details">
                                    <span>üë§ User: <strong>${escapeHtml(displayName)}</strong></span>
                                    <span>üîå Ports: <code>${portsStr}</code></span>
                                    <span>üåê URL: <code>${instance.public_url || 'N/A'}</code></span>
                                    <span>‚è∞ Expires: ${formatTime(instance.expires_at)}</span>
                                </div>
                            </div>
                            <div class="instance-actions">
                                <button class="btn btn-danger btn-sm" onclick="adminStopInstance('${instance.instance_id}')">
                                    üõë Force Stop
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                container.innerHTML = '<div class="empty-state">Failed to load instances</div>';
            }
        }

        async function adminStopInstance(instanceId) {
            if (!confirm(`Force stop instance ${instanceId}?`)) return;

            try {
                await fetch(`/admin/api/instances/${instanceId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-Admin-Key': adminKey
                    }
                });

                showToast('Instance stopped', 'success');
                await loadAllInstances();
                await loadStats();
            } catch (error) {
                showToast('Failed to stop instance', 'error');
            }
        }

        let totalLogs = 0;

        function debounceLoadLogs() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                currentPage = 0; // Reset to first page on filter change
                loadLogs();
            }, 300);
        }

        async function loadLogs() {
            const tbody = document.getElementById('logs-body');
            const paginationDiv = document.getElementById('pagination');
            const eventType = document.getElementById('filter-event-type').value;
            const userFilter = document.getElementById('filter-user').value;
            const limit = parseInt(document.getElementById('filter-limit').value);

            let url = `/admin/api/logs?limit=${limit}&offset=${currentPage * limit}`;
            if (eventType) url += `&event_type=${eventType}`;
            if (userFilter) url += `&username=${encodeURIComponent(userFilter)}`;

            try {
                const data = await adminApi(url);
                const logs = data.logs || [];
                totalLogs = data.total || 0;

                if (logs.length === 0 && currentPage === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No logs found</td></tr>';
                    paginationDiv.innerHTML = '';
                    return;
                }

                if (logs.length === 0 && currentPage > 0) {
                    // No more logs, go back
                    currentPage--;
                    loadLogs();
                    return;
                }

                tbody.innerHTML = logs.map(log => {
                    const portsStr = log.ports
                        ? Object.entries(log.ports).map(([i, e]) => `${i}‚Üí${e}`).join(', ')
                        : '-';

                    return `
                        <tr>
                            <td class="log-time">${formatTime(log.timestamp)}</td>
                            <td><span class="log-event event-${log.event_type}">${log.event_type}</span></td>
                            <td class="log-user">${escapeHtml(log.username || '-')}</td>
                            <td>${escapeHtml(log.challenge_id || '-')}</td>
                            <td class="log-ports">${portsStr}</td>
                            <td class="log-url">${escapeHtml(log.public_url || '-')}</td>
                            <td>${escapeHtml(log.ip_address || '-')}</td>
                            <td class="log-message" title="${escapeHtml(log.message)}">${escapeHtml(log.message)}</td>
                        </tr>
                    `;
                }).join('');

                // Render pagination
                renderPagination(totalLogs, limit);

            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Failed to load logs</td></tr>';
                paginationDiv.innerHTML = '';
            }
        }

        function renderPagination(total, limit) {
            const paginationDiv = document.getElementById('pagination');
            const totalPages = Math.ceil(total / limit);

            if (totalPages <= 1) {
                paginationDiv.innerHTML = `<span class="page-info">Showing ${total} entries</span>`;
                return;
            }

            let html = '';

            // Previous button
            html += `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 0 ? 'disabled' : ''}>¬´ Prev</button>`;

            // Page numbers
            const maxButtons = 5;
            let startPage = Math.max(0, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages - 1, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(0, endPage - maxButtons + 1);
            }

            if (startPage > 0) {
                html += `<button onclick="goToPage(0)">1</button>`;
                if (startPage > 1) html += `<span class="page-info">...</span>`;
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="goToPage(${i})" class="${i === currentPage ? 'active' : ''}">${i + 1}</button>`;
            }

            if (endPage < totalPages - 1) {
                if (endPage < totalPages - 2) html += `<span class="page-info">...</span>`;
                html += `<button onclick="goToPage(${totalPages - 1})">${totalPages}</button>`;
            }

            // Next button
            html += `<button onclick="goToPage(${currentPage + 1})" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>Next ¬ª</button>`;

            // Page info
            const start = currentPage * limit + 1;
            const end = Math.min((currentPage + 1) * limit, total);
            html += `<span class="page-info">Showing ${start}-${end} of ${total}</span>`;

            paginationDiv.innerHTML = html;
        }

        function goToPage(page) {
            if (page < 0) return;
            currentPage = page;
            loadLogs();
        }

        async function exportLogsJSON() {
            try {
                showToast('Fetching all logs...', 'info');

                const eventType = document.getElementById('filter-event-type').value;
                const userFilter = document.getElementById('filter-user').value;

                // Fetch all logs (up to 10000)
                let url = `/admin/api/logs?limit=10000&offset=0`;
                if (eventType) url += `&event_type=${eventType}`;
                if (userFilter) url += `&username=${encodeURIComponent(userFilter)}`;

                const data = await adminApi(url);
                const logs = data.logs || [];

                if (logs.length === 0) {
                    showToast('No logs to export', 'error');
                    return;
                }

                // Create JSON blob and download
                const json = JSON.stringify(logs, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const filename = `whaley-logs-${new Date().toISOString().slice(0, 10)}.json`;

                downloadBlob(blob, filename);
                showToast(`Exported ${logs.length} logs as JSON`, 'success');
            } catch (error) {
                showToast('Failed to export logs', 'error');
            }
        }

        async function exportLogsCSV() {
            try {
                showToast('Fetching all logs...', 'info');

                const eventType = document.getElementById('filter-event-type').value;
                const userFilter = document.getElementById('filter-user').value;

                // Fetch all logs (up to 10000)
                let url = `/admin/api/logs?limit=10000&offset=0`;
                if (eventType) url += `&event_type=${eventType}`;
                if (userFilter) url += `&username=${encodeURIComponent(userFilter)}`;

                const data = await adminApi(url);
                const logs = data.logs || [];

                if (logs.length === 0) {
                    showToast('No logs to export', 'error');
                    return;
                }

                // CSV headers
                const headers = ['timestamp', 'event_type', 'username', 'user_id', 'challenge_id', 'instance_id', 'ports', 'public_url', 'ip_address', 'message'];

                // Convert to CSV
                let csv = headers.join(',') + '\n';

                for (const log of logs) {
                    const row = headers.map(h => {
                        let val = log[h];
                        if (val === null || val === undefined) return '';
                        if (h === 'ports' && typeof val === 'object') {
                            val = Object.entries(val).map(([k, v]) => `${k}:${v}`).join(';');
                        }
                        // Escape CSV special chars
                        val = String(val).replace(/"/g, '""');
                        if (val.includes(',') || val.includes('"') || val.includes('\n')) {
                            val = `"${val}"`;
                        }
                        return val;
                    });
                    csv += row.join(',') + '\n';
                }

                // Create CSV blob and download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const filename = `whaley-logs-${new Date().toISOString().slice(0, 10)}.csv`;

                downloadBlob(blob, filename);
                showToast(`Exported ${logs.length} logs as CSV`, 'success');
            } catch (error) {
                showToast('Failed to export logs', 'error');
            }
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // User Ports tab state
        let allUserPorts = {};

        function switchLogTab(tab) {
            // Update sub-tab buttons
            document.querySelectorAll('.sub-tab').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            const activeBtn = document.querySelector(`.sub-tab[data-subtab="${tab}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.classList.add('btn-primary');
                activeBtn.classList.remove('btn-secondary');
            }

            // Show/hide sections
            document.getElementById('section-events').classList.toggle('hidden', tab !== 'events');
            document.getElementById('section-ports').classList.toggle('hidden', tab !== 'ports');
            document.getElementById('section-forensics').classList.toggle('hidden', tab !== 'forensics');

            // Load data
            if (tab === 'events') {
                loadLogs();
            } else if (tab === 'ports') {
                loadUserPorts();
            } else if (tab === 'forensics') {
                loadForensicsLogs();
            }
        }

        async function loadUserPorts() {
            const tbody = document.getElementById('user-ports-body');
            const summary = document.getElementById('ports-summary');

            try {
                const data = await adminApi('/admin/api/user-ports');
                allUserPorts = data.user_ports || {};

                renderUserPorts();

                // Update summary (exclude _username keys)
                const totalUsers = Object.keys(allUserPorts).length;
                let totalMappings = 0;
                for (const userId in allUserPorts) {
                    for (const key in allUserPorts[userId]) {
                        if (!key.startsWith('_')) totalMappings++;
                    }
                }
                summary.textContent = `Total: ${totalUsers} users, ${totalMappings} challenge mappings`;

            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Failed to load user ports</td></tr>';
                summary.textContent = '';
            }
        }

        function renderUserPorts() {
            const tbody = document.getElementById('user-ports-body');
            const userFilter = (document.getElementById('filter-port-user')?.value || '').toLowerCase();
            const challengeFilter = (document.getElementById('filter-port-challenge')?.value || '').toLowerCase();

            const rows = [];

            for (const userId in allUserPorts) {
                const userData = allUserPorts[userId];
                const username = userData._username || userId;

                for (const challengeId in userData) {
                    if (challengeId.startsWith('_')) continue; // Skip metadata

                    // Apply filters (search both username and userId)
                    const matchesUser = !userFilter ||
                        username.toLowerCase().includes(userFilter) ||
                        userId.toLowerCase().includes(userFilter);
                    if (!matchesUser) continue;
                    if (challengeFilter && !challengeId.toLowerCase().includes(challengeFilter)) continue;

                    const ports = userData[challengeId];
                    if (typeof ports !== 'object') continue;

                    const portMappings = Object.entries(ports)
                        .map(([internal, external]) => `<span class="log-ports">${internal}‚Üí${external}</span>`)
                        .join(' ');

                    rows.push(`
                        <tr>
                            <td class="log-user" title="ID: ${escapeHtml(userId)}">${escapeHtml(username)}</td>
                            <td>${escapeHtml(challengeId)}</td>
                            <td>${portMappings}</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteUserPorts('${escapeHtml(userId)}', '${escapeHtml(challengeId)}')" title="Delete mapping">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                    `);
                }
            }

            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No port mappings found</td></tr>';
            } else {
                tbody.innerHTML = rows.join('');
            }
        }

        function filterUserPorts() {
            renderUserPorts();
        }

        async function deleteUserPorts(userId, challengeId) {
            if (!confirm(`Delete port mapping for user "${userId}" on challenge "${challengeId}"?\n\nThis will allow the user to get new random ports on their next spawn.`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/api/user-ports/${encodeURIComponent(userId)}?challenge_id=${encodeURIComponent(challengeId)}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Key': adminKey }
                });
                if (response.ok) {
                    showToast(`Deleted port mapping for ${userId}/${challengeId}`, 'success');
                    loadUserPorts();
                } else {
                    const data = await response.json();
                    showToast(data.detail || 'Failed to delete', 'error');
                }
            } catch (error) {
                showToast('Failed to delete port mapping', 'error');
            }
        }

        async function clearAllUserPorts() {
            if (!confirm('‚ö†Ô∏è Clear ALL user port mappings?\n\nThis will reset persistent ports for ALL users.\nThey will get new random ports on next spawn.')) {
                return;
            }

            try {
                const response = await fetch('/admin/api/user-ports', {
                    method: 'DELETE',
                    headers: { 'X-Admin-Key': adminKey }
                });
                if (response.ok) {
                    const data = await response.json();
                    showToast(data.message, 'success');
                    loadUserPorts();
                } else {
                    showToast('Failed to clear mappings', 'error');
                }
            } catch (error) {
                showToast('Failed to clear mappings', 'error');
            }
        }

        function formatTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è' };
            toast.innerHTML = `<span>${icons[type] || icons.info}</span><span>${escapeHtml(message)}</span>`;

            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // =============================================================================
        // Instance Forensics Functions
        // =============================================================================

        let allForensicsLogs = [];
        let forensicsPage = 1;
        const FORENSICS_PER_PAGE = 10;

        async function loadForensicsLogs() {
            const tbody = document.getElementById('forensics-logs-body');

            try {
                // Load stats
                const statsData = await adminApi('/admin/api/forensics/stats');
                document.getElementById('stat-forensics-status').textContent = statsData.auto_capture_enabled ? 'ON' : 'OFF';
                document.getElementById('stat-forensics-status').style.color = statsData.auto_capture_enabled ? 'var(--accent-success)' : 'var(--text-muted)';
                document.getElementById('stat-forensics-total').textContent = statsData.total_logs;
                document.getElementById('stat-forensics-auto').textContent = statsData.auto_capture_count;
                document.getElementById('stat-forensics-live').textContent = statsData.live_capture_count;
                document.getElementById('stat-forensics-size').textContent = statsData.total_size_mb + ' MB';
                document.getElementById('forensics-auto-capture').checked = statsData.auto_capture_enabled;

                // Load logs
                const logsData = await adminApi('/admin/api/forensics/logs?limit=200');
                allForensicsLogs = logsData.logs || [];

                // Load running instances for live capture dropdown
                await loadLiveCaptureInstances();

                // Render logs
                forensicsPage = 1;
                filterForensicsLogs();

            } catch (error) {
                console.error('Failed to load forensics data:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Failed to load forensics logs</td></tr>';
            }
        }

        async function loadLiveCaptureInstances() {
            const select = document.getElementById('forensics-live-instance');

            try {
                const data = await adminApi('/admin/api/instances');
                const instances = data.instances || [];

                select.innerHTML = '<option value="">-- Select Running Instance --</option>';

                instances.filter(i => i.status === 'running').forEach(instance => {
                    const option = document.createElement('option');
                    option.value = instance.instance_id;
                    option.textContent = `${instance.challenge_id} - ${instance.team_name || instance.username} (${instance.instance_id.slice(-8)})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load instances for live capture:', error);
            }
        }

        function filterForensicsLogs() {
            const typeFilter = document.getElementById('filter-forensics-type')?.value || '';
            const challengeFilter = (document.getElementById('filter-forensics-challenge')?.value || '').toLowerCase();
            const ownerFilter = (document.getElementById('filter-forensics-owner')?.value || '').toLowerCase();

            let filtered = allForensicsLogs;

            if (typeFilter) {
                filtered = filtered.filter(log => log.capture_type === typeFilter);
            }
            if (challengeFilter) {
                filtered = filtered.filter(log =>
                    log.challenge_id.toLowerCase().includes(challengeFilter) ||
                    log.challenge_name.toLowerCase().includes(challengeFilter)
                );
            }
            if (ownerFilter) {
                filtered = filtered.filter(log =>
                    log.owner_name.toLowerCase().includes(ownerFilter) ||
                    log.spawned_by.toLowerCase().includes(ownerFilter) ||
                    (log.team_name && log.team_name.toLowerCase().includes(ownerFilter))
                );
            }

            renderForensicsLogs(filtered);
        }

        function renderForensicsLogs(logs) {
            const tbody = document.getElementById('forensics-logs-body');

            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No forensics logs found</td></tr>';
                updatePagination('forensics', 0, 0, 0);
                return;
            }

            const totalPages = Math.ceil(logs.length / FORENSICS_PER_PAGE);
            forensicsPage = Math.max(1, Math.min(forensicsPage, totalPages));
            const start = (forensicsPage - 1) * FORENSICS_PER_PAGE;
            const end = start + FORENSICS_PER_PAGE;
            const pageItems = logs.slice(start, end);

            tbody.innerHTML = pageItems.map(log => {
                const typeClass = log.capture_type === 'auto' ? 'auto' : 'live';
                const typeLabel = log.capture_type === 'auto' ? 'ü§ñ Auto' : 'üì∏ Live';
                const sizeKB = Math.round(log.file_size_bytes / 1024);
                const sizeDisplay = sizeKB > 1024 ? `${(sizeKB / 1024).toFixed(1)} MB` : `${sizeKB} KB`;

                const ownerDisplay = log.team_name
                    ? `${escapeHtml(log.team_name)}<br><span style="font-size: 0.75rem; color: var(--text-muted);">Team</span>`
                    : escapeHtml(log.owner_name);

                // Container names display
                const containerNames = log.container_names || [];
                let containersHtml = '';
                if (containerNames.length === 0) {
                    containersHtml = `<span style="color: var(--text-muted);">${log.container_count} container(s)</span>`;
                } else if (containerNames.length === 1) {
                    containersHtml = `<code style="font-size: 0.75rem;">${escapeHtml(containerNames[0])}</code>`;
                } else {
                    containersHtml = containerNames.map(n => `<code style="font-size: 0.7rem; display: block; margin: 1px 0;">${escapeHtml(n)}</code>`).join('');
                }

                return `
                <tr>
                    <td class="log-time">${formatTime(log.capture_time)}</td>
                    <td><span class="forensics-type ${typeClass}">${typeLabel}</span></td>
                    <td title="${escapeHtml(log.challenge_id)}">${escapeHtml(log.challenge_name)}</td>
                    <td>${containersHtml}</td>
                    <td>${ownerDisplay}</td>
                    <td>${escapeHtml(log.spawned_by)}</td>
                    <td><span class="forensics-reason">${escapeHtml(log.terminate_reason)}</span></td>
                    <td>${sizeDisplay}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="viewForensicsLog('${log.log_id}')" title="View Log">
                            üëÅÔ∏è
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteForensicsLog('${log.log_id}')" title="Delete">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `;
            }).join('');

            updatePagination('forensics', forensicsPage, totalPages, logs.length);
        }

        async function toggleForensicsAutoCapture() {
            const checkbox = document.getElementById('forensics-auto-capture');
            const enabled = checkbox.checked;

            // Confirmation when enabling
            if (enabled) {
                const confirmed = confirm(
                    '‚ö†Ô∏è Enable Auto Capture?\n\n' +
                    'This will automatically dump container logs when instances terminate.\n\n' +
                    'Impact:\n' +
                    '‚Ä¢ Additional disk space required (+10-30 GB)\n' +
                    '‚Ä¢ Slight I/O overhead on instance terminate\n' +
                    '‚Ä¢ Logs stored for ' + (await getRetentionHours()) + ' hours\n\n' +
                    'For large events (150+ teams), consider using Live Capture only.\n\n' +
                    'Continue?'
                );
                if (!confirmed) {
                    checkbox.checked = false;
                    return;
                }
            }

            try {
                const response = await fetch(`/admin/api/forensics/toggle?enabled=${enabled}`, {
                    method: 'POST',
                    headers: { 'X-Admin-Key': adminKey }
                });

                if (response.ok) {
                    const data = await response.json();
                    showToast(data.message, 'success');
                    document.getElementById('stat-forensics-status').textContent = enabled ? 'ON' : 'OFF';
                    document.getElementById('stat-forensics-status').style.color = enabled ? 'var(--accent-success)' : 'var(--text-muted)';
                } else {
                    checkbox.checked = !enabled; // Revert
                    showToast('Failed to toggle auto capture', 'error');
                }
            } catch (error) {
                checkbox.checked = !enabled; // Revert
                showToast('Failed to toggle auto capture', 'error');
            }
        }

        async function getRetentionHours() {
            try {
                const stats = await adminApi('/admin/api/forensics/stats');
                return stats.retention_hours || 168;
            } catch {
                return 168;
            }
        }

        async function doLiveCapture() {
            const select = document.getElementById('forensics-live-instance');
            const instanceId = select.value;

            if (!instanceId) {
                showToast('Please select an instance first', 'error');
                return;
            }

            try {
                showToast('Capturing logs...', 'info');

                const response = await fetch(`/admin/api/forensics/live-capture/${instanceId}`, {
                    method: 'POST',
                    headers: { 'X-Admin-Key': adminKey }
                });

                if (response.ok) {
                    const data = await response.json();
                    showToast(`Live capture complete: ${data.message}`, 'success');
                    loadForensicsLogs();
                } else {
                    const err = await response.json();
                    showToast(`Capture failed: ${err.detail}`, 'error');
                }
            } catch (error) {
                showToast('Live capture failed', 'error');
            }
        }

        async function viewForensicsLog(logId) {
            try {
                showToast('Loading log content...', 'info');

                const data = await adminApi(`/admin/api/forensics/logs/${logId}`);

                if (!data || !data.content) {
                    showToast('Log content is empty', 'error');
                    return;
                }

                // Remove existing modal if any
                const existingModal = document.querySelector('.forensics-modal');
                if (existingModal) existingModal.remove();

                // Create modal to display log
                const modal = document.createElement('div');
                modal.className = 'modal-overlay forensics-modal active';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 80vh; display: flex; flex-direction: column;">
                        <div class="modal-header">
                            <h3>üîç Forensics Log: ${escapeHtml(logId)}</h3>
                            <button class="btn btn-secondary btn-sm" onclick="closeForensicsModal()">‚úï</button>
                        </div>
                        <div class="modal-body" style="overflow: auto; flex: 1;">
                            <pre style="background: var(--bg-primary); padding: 16px; border-radius: var(--radius-sm); font-size: 0.8rem; white-space: pre-wrap; word-wrap: break-word; overflow-x: auto; margin: 0;">${escapeHtml(data.content)}</pre>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary btn-sm" onclick="copyForensicsLog()">üìã Copy to Clipboard</button>
                            <button class="btn btn-secondary btn-sm" onclick="downloadForensicsLog('${escapeHtml(logId)}')">üíæ Download</button>
                            <button class="btn btn-secondary btn-sm" onclick="closeForensicsModal()">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Store content globally for copy/download
                window._forensicsLogContent = data.content;

                // Close on overlay click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeForensicsModal();
                });

            } catch (error) {
                console.error('Failed to load log:', error);
                showToast('Failed to load log content', 'error');
            }
        }

        function closeForensicsModal() {
            const modal = document.querySelector('.forensics-modal');
            if (modal) modal.remove();
            window._forensicsLogContent = null;
        }

        function copyForensicsLog() {
            if (window._forensicsLogContent) {
                navigator.clipboard.writeText(window._forensicsLogContent);
                showToast('Log copied to clipboard', 'success');
            }
        }

        function downloadForensicsLog(logId) {
            if (window._forensicsLogContent) {
                const blob = new Blob([window._forensicsLogContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `forensics_${logId}.log`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Log downloaded', 'success');
            }
        }

        async function deleteForensicsLog(logId) {
            if (!confirm(`Delete forensics log "${logId}"?`)) return;

            try {
                const response = await fetch(`/admin/api/forensics/logs/${logId}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Key': adminKey }
                });

                if (response.ok) {
                    showToast('Log deleted', 'success');
                    loadForensicsLogs();
                } else {
                    showToast('Failed to delete log', 'error');
                }
            } catch (error) {
                showToast('Failed to delete log', 'error');
            }
        }

        async function clearForensicsLogs() {
            if (!confirm('‚ö†Ô∏è Delete ALL forensics logs?\n\nThis action cannot be undone.')) return;

            try {
                const response = await fetch('/admin/api/forensics/logs', {
                    method: 'DELETE',
                    headers: { 'X-Admin-Key': adminKey }
                });

                if (response.ok) {
                    const data = await response.json();
                    showToast(data.message, 'success');
                    loadForensicsLogs();
                } else {
                    showToast('Failed to clear logs', 'error');
                }
            } catch (error) {
                showToast('Failed to clear logs', 'error');
            }
        }

        // =============================================================================
        // Dynamic Flags Functions 
        // =============================================================================

        let allFlagMappings = [];
        const ITEMS_PER_PAGE = 5;
        let suspiciousPage = 1;
        let suspiciousData = [];
        let flagMappingsPage = 1;
        let challengeMappingsPage = 1;
        let challengeMappingsData = [];

        async function loadFlagsData() {
            try {
                // Fetch flags data and challenges in parallel
                const [flagsData, challengesData] = await Promise.all([
                    adminApi('/admin/api/flags'),
                    adminApi('/admin/api/challenges/list')
                ]);

                const localChallenges = (challengesData.challenges || []).filter(c => c.loaded);

                // Update stats
                document.getElementById('stat-flags-enabled').textContent =
                    flagsData.dynamic_flags_enabled ? 'Enabled' : 'Disabled';
                document.getElementById('stat-flags-enabled').style.color =
                    flagsData.dynamic_flags_enabled ? 'var(--accent-success)' : 'var(--accent-danger)';
                document.getElementById('stat-total-flags').textContent = flagsData.total_flags || 0;
                document.getElementById('stat-flags-users').textContent = flagsData.total_users || 0;
                document.getElementById('stat-suspicious').textContent =
                    (flagsData.suspicious_submissions || []).length;

                // Store mappings for filtering - sort by created_at descending (newest first)
                allFlagMappings = (flagsData.flag_mappings || []).sort((a, b) => {
                    const dateA = new Date(a.created_at || 0);
                    const dateB = new Date(b.created_at || 0);
                    return dateB - dateA;  // Descending order (newest first)
                });

                // Store suspicious data - sort by submission_time descending (newest first)
                suspiciousData = (flagsData.suspicious_submissions || []).sort((a, b) => {
                    const dateA = new Date(a.submission_time || 0);
                    const dateB = new Date(b.submission_time || 0);
                    return dateB - dateA;  // Descending order (newest first)
                });
                suspiciousPage = 1;
                renderSuspiciousSubmissions();

                // Reset pagination for flag mappings
                flagMappingsPage = 1;
                renderFlagMappings();

                // Render challenge mappings with local challenges
                challengeMappingsPage = 1;
                renderChallengeMappings(flagsData.challenge_mapping || {}, localChallenges);

            } catch (error) {
                console.error('Failed to load flags data:', error);
                showToast('Failed to load flags data', 'error');
            }
        }

        function renderSuspiciousSubmissions() {
            const tbody = document.getElementById('suspicious-body');
            const submissions = suspiciousData;

            if (submissions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No suspicious submissions found üéâ</td></tr>';
                updatePagination('suspicious', 0, 0, 0);
                return;
            }

            const totalPages = Math.ceil(submissions.length / ITEMS_PER_PAGE);
            suspiciousPage = Math.max(1, Math.min(suspiciousPage, totalPages));
            const start = (suspiciousPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageItems = submissions.slice(start, end);

            tbody.innerHTML = pageItems.map(s => {
                // Check if team mode - show team info
                const isTeamMode = s.submitter_team_id || s.flag_owner_team_id;

                let submitterHtml, ownerHtml;
                if (isTeamMode) {
                    // Team mode: show team name (with user name as secondary)
                    submitterHtml = `
                        <strong>${escapeHtml(s.submitter_team_name || 'Unknown Team')}</strong>
                        <span style="font-size: 0.75rem; color: var(--text-muted);"> (Team)</span>
                        <br><span style="font-size: 0.75rem; color: var(--text-muted);">by ${escapeHtml(s.submitter_username)}</span>
                    `;
                    ownerHtml = `
                        ${escapeHtml(s.flag_owner_team_name || 'Unknown Team')}
                        <span style="font-size: 0.75rem; color: var(--text-muted);"> (Team's flag)</span>
                    `;
                } else {
                    // User mode: show user info
                    submitterHtml = `
                        <strong>${escapeHtml(s.submitter_username)}</strong>
                        <span style="font-size: 0.75rem; color: var(--text-muted);"> (submitted)</span>
                    `;
                    ownerHtml = `
                        ${escapeHtml(s.flag_owner_username)}
                        <span style="font-size: 0.75rem; color: var(--text-muted);"> (flag owner)</span>
                    `;
                }

                return `
                <tr style="background: rgba(239, 68, 68, 0.1);">
                    <td class="log-time">${formatTime(s.submission_time)}</td>
                    <td class="log-user" style="color: var(--accent-danger);">
                        ${submitterHtml}
                    </td>
                    <td class="log-user" style="color: var(--accent-warning);">
                        ${ownerHtml}
                    </td>
                    <td>${escapeHtml(s.local_challenge_id)}</td>
                    <td>${escapeHtml(s.ip_address)}</td>
                </tr>
            `;
            }).join('');

            updatePagination('suspicious', suspiciousPage, totalPages, submissions.length);
        }

        function renderFlagMappings() {
            const tbody = document.getElementById('flag-mappings-body');
            const userFilter = (document.getElementById('filter-flag-user')?.value || '').toLowerCase();
            const challengeFilter = (document.getElementById('filter-flag-challenge')?.value || '').toLowerCase();

            let filtered = allFlagMappings;

            if (userFilter) {
                filtered = filtered.filter(m =>
                    m.username.toLowerCase().includes(userFilter) ||
                    m.user_id.toLowerCase().includes(userFilter) ||
                    (m.team_name && m.team_name.toLowerCase().includes(userFilter))
                );
            }

            if (challengeFilter) {
                filtered = filtered.filter(m =>
                    m.local_challenge_id.toLowerCase().includes(challengeFilter)
                );
            }

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No flag mappings found</td></tr>';
                updatePagination('flag-mappings', 0, 0, 0);
                return;
            }

            const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
            flagMappingsPage = Math.max(1, Math.min(flagMappingsPage, totalPages));
            const start = (flagMappingsPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageItems = filtered.slice(start, end);

            tbody.innerHTML = pageItems.map(m => {
                // Check if team mode - show team info
                const isTeamMode = m.team_id && m.team_name;
                let ownerHtml;
                if (isTeamMode) {
                    ownerHtml = `
                        <strong>${escapeHtml(m.team_name)}</strong>
                        <span style="font-size: 0.75rem; color: var(--text-muted);"> (Team)</span>
                        <br><span style="font-size: 0.75rem; color: var(--text-muted);">by ${escapeHtml(m.username)}</span>
                    `;
                } else {
                    ownerHtml = `${escapeHtml(m.username)}`;
                }

                return `
                <tr>
                    <td class="log-user" title="ID: ${escapeHtml(m.user_id)}${m.team_id ? ', Team ID: ' + escapeHtml(m.team_id) : ''}">
                        ${ownerHtml}
                    </td>
                    <td>${escapeHtml(m.local_challenge_id)}</td>
                    <td style="font-family: monospace; font-size: 0.8rem; color: var(--text-muted);">
                        ${escapeHtml(m.flag_content.substring(0, 25))}...
                    </td>
                    <td class="log-time">${formatTime(m.created_at)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteFlagMapping(${m.flag_id}, '${escapeHtml(isTeamMode ? m.team_name : m.username)}')"
                            title="Delete this flag from CTFd">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `;
            }).join('');

            updatePagination('flag-mappings', flagMappingsPage, totalPages, filtered.length);
        }

        function filterFlagMappings() {
            flagMappingsPage = 1;
            renderFlagMappings();
        }

        async function deleteFlagMapping(flagId, username) {
            if (!confirm(`Delete flag mapping for user "${username}"?\n\nThis will also remove the flag from CTFd.`)) return;

            try {
                const res = await fetch(`/admin/api/flags/${flagId}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Key': adminKey }
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Failed to delete flag');
                }

                showToast(`Deleted flag for ${username}`, 'success');
                await loadFlagsData();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function renderChallengeMappings(mappings, localChallenges = []) {
            const tbody = document.getElementById('challenge-mapping-body');
            const select = document.getElementById('mapping-local-id');

            // Populate dropdown with local challenges
            if (localChallenges.length > 0) {
                select.innerHTML = '<option value="">-- Select Challenge --</option>' +
                    localChallenges.map(c => `<option value="${escapeHtml(c.id)}">${escapeHtml(c.id)}</option>`).join('');
            }

            // Merge local challenges with mappings
            const allChallenges = new Set([
                ...Object.keys(mappings),
                ...localChallenges.map(c => c.id)
            ]);

            if (allChallenges.size === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No challenges found</td></tr>';
                updatePagination('challenge-mapping', 0, 0, 0);
                return;
            }

            // Store as array for pagination
            challengeMappingsData = Array.from(allChallenges).map(localId => ({
                localId,
                ctfdId: mappings[localId],
                isMapped: mappings[localId] !== undefined
            }));

            const totalPages = Math.ceil(challengeMappingsData.length / ITEMS_PER_PAGE);
            challengeMappingsPage = Math.max(1, Math.min(challengeMappingsPage, totalPages));
            const start = (challengeMappingsPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageItems = challengeMappingsData.slice(start, end);

            const rows = pageItems.map(item => `
                <tr>
                    <td><strong>${escapeHtml(item.localId)}</strong></td>
                    <td style="font-family: monospace;">
                        ${item.isMapped ? `#${item.ctfdId}` : '<span style="color: var(--text-muted);">Not mapped</span>'}
                    </td>
                    <td>
                        ${item.isMapped
                    ? '<span style="color: var(--accent-success);">Configured</span>'
                    : '<span style="color: var(--accent-warning);">Needs mapping</span>'}
                    </td>
                    <td>
                        ${item.isMapped
                    ? `<button class="btn btn-danger btn-sm" onclick="removeChallengeMapping('${escapeHtml(item.localId)}')">üóëÔ∏è</button>`
                    : ''}
                    </td>
                </tr>
            `);

            tbody.innerHTML = rows.join('');
            updatePagination('challenge-mapping', challengeMappingsPage, totalPages, challengeMappingsData.length);
        }

        async function addChallengeMapping() {
            const localId = document.getElementById('mapping-local-id').value;
            const ctfdId = parseInt(document.getElementById('mapping-ctfd-id').value);

            if (!localId) {
                showToast('Please select a local challenge', 'error');
                return;
            }

            if (!ctfdId || ctfdId < 1) {
                showToast('Please enter a valid CTFd challenge ID', 'error');
                return;
            }

            try {
                const params = new URLSearchParams({
                    local_challenge_id: localId,
                    ctfd_challenge_id: ctfdId.toString()
                });

                const res = await fetch(`/admin/api/flags/sync-challenge?${params}`, {
                    method: 'POST',
                    headers: { 'X-Admin-Key': adminKey }
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Failed to add mapping');
                }

                showToast(`Mapped ${localId} ‚Üí CTFd #${ctfdId}`, 'success');
                document.getElementById('mapping-ctfd-id').value = '';
                await loadFlagsData();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function removeChallengeMapping(localId) {
            if (!confirm(`Remove mapping for "${localId}"?`)) return;

            try {
                const res = await fetch(`/admin/api/flags/mapping/${encodeURIComponent(localId)}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Key': adminKey }
                });

                if (!res.ok) {
                    throw new Error('Failed to remove mapping');
                }

                showToast(`Removed mapping for ${localId}`, 'success');
                await loadFlagsData();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function updatePagination(tableId, currentPage, totalPages, totalItems) {
            const container = document.getElementById(`pagination-${tableId}`);
            if (!container) return;

            if (totalItems === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div class="pagination-controls">
                    <button class="btn btn-secondary btn-sm" onclick="changePage('${tableId}', -1)" ${currentPage <= 1 ? 'disabled' : ''}>
                        ‚Üê Prev
                    </button>
                    <span class="pagination-info">Page ${currentPage} of ${totalPages} (${totalItems} items)</span>
                    <button class="btn btn-secondary btn-sm" onclick="changePage('${tableId}', 1)" ${currentPage >= totalPages ? 'disabled' : ''}>
                        Next ‚Üí
                    </button>
                </div>
            `;
        }

        function changePage(tableId, delta) {
            switch (tableId) {
                case 'suspicious':
                    suspiciousPage += delta;
                    renderSuspiciousSubmissions();
                    break;
                case 'flag-mappings':
                    flagMappingsPage += delta;
                    renderFlagMappings();
                    break;
                case 'challenge-mapping':
                    challengeMappingsPage += delta;
                    renderChallengeMappingsFromCache();
                    break;
            }
        }

        function renderChallengeMappingsFromCache() {
            // Re-render using cached challengeMappingsData
            const tbody = document.getElementById('challenge-mapping-body');

            if (challengeMappingsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No challenges found</td></tr>';
                updatePagination('challenge-mapping', 0, 0, 0);
                return;
            }

            const totalPages = Math.ceil(challengeMappingsData.length / ITEMS_PER_PAGE);
            challengeMappingsPage = Math.max(1, Math.min(challengeMappingsPage, totalPages));
            const start = (challengeMappingsPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageItems = challengeMappingsData.slice(start, end);

            const rows = pageItems.map(item => `
                <tr>
                    <td><strong>${escapeHtml(item.localId)}</strong></td>
                    <td style="font-family: monospace;">
                        ${item.isMapped ? `#${item.ctfdId}` : '<span style="color: var(--text-muted);">Not mapped</span>'}
                    </td>
                    <td>
                        ${item.isMapped
                    ? '<span style="color: var(--accent-success);">Configured</span>'
                    : '<span style="color: var(--accent-warning);">Needs mapping</span>'}
                    </td>
                    <td>
                        ${item.isMapped
                    ? `<button class="btn btn-danger btn-sm" onclick="removeChallengeMapping('${escapeHtml(item.localId)}')">üóëÔ∏è</button>`
                    : ''}
                    </td>
                </tr>
            `);

            tbody.innerHTML = rows.join('');
            updatePagination('challenge-mapping', challengeMappingsPage, totalPages, challengeMappingsData.length);
        }

        async function checkSubmissions() {
            try {
                showToast('Checking submissions...', 'info');
                const data = await adminApi('/admin/api/flags/check-submissions', 'POST');

                if (data.new_suspicious_count > 0) {
                    showToast(`Found ${data.new_suspicious_count} new suspicious submissions!`, 'error');
                } else {
                    showToast('No new suspicious submissions found', 'success');
                }

                // Reload data
                await loadFlagsData();
            } catch (error) {
                showToast('Failed to check submissions', 'error');
            }
        }

        async function clearSuspicious() {
            if (!confirm('Clear all suspicious submission records?')) return;

            try {
                await fetch('/admin/api/flags/suspicious', {
                    method: 'DELETE',
                    headers: { 'X-Admin-Key': adminKey }
                });
                showToast('Cleared suspicious submissions', 'success');
                await loadFlagsData();
            } catch (error) {
                showToast('Failed to clear', 'error');
            }
        }

        // =============================================================================
        // CTFd Sync Wizard Functions
        // =============================================================================

        let ctfdChallengesCache = [];
        let ctfdCategoriesCache = [];
        let localChallengesCache = [];

        function openSyncWizard() {
            document.getElementById('sync-wizard-modal').classList.add('active');
            // Auto-fetch on open
            fetchCtfdChallenges();
        }

        function closeSyncWizard(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('sync-wizard-modal').classList.remove('active');
        }

        async function fetchCtfdChallenges() {
            const listContainer = document.getElementById('ctfd-challenge-list');
            const categorySelect = document.getElementById('sync-category');

            listContainer.innerHTML = '<div class="loading">Fetching challenges from CTFd...</div>';

            try {
                // Also fetch local challenges for mapping
                const [ctfdData, localData] = await Promise.all([
                    adminApi('/admin/api/ctfd/challenges'),
                    adminApi('/admin/api/challenges/list')
                ]);

                ctfdChallengesCache = ctfdData.challenges || [];
                ctfdCategoriesCache = ctfdData.categories || [];
                localChallengesCache = (localData.challenges || []).filter(c => c.loaded);

                // Populate category filter
                categorySelect.innerHTML = '<option value="">All Categories</option>' +
                    ctfdCategoriesCache.map(cat =>
                        `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`
                    ).join('');

                renderSyncChallenges();

            } catch (error) {
                listContainer.innerHTML = `<div class="empty-state" style="color: var(--accent-danger);">
                    Failed to fetch: ${escapeHtml(error.message || 'Unknown error')}
                </div>`;
            }
        }

        function filterSyncChallenges() {
            renderSyncChallenges();
        }

        function renderSyncChallenges() {
            const listContainer = document.getElementById('ctfd-challenge-list');
            const statsContainer = document.getElementById('sync-stats');
            const searchTerm = (document.getElementById('sync-search')?.value || '').toLowerCase();
            const categoryFilter = document.getElementById('sync-category')?.value || '';

            let filtered = ctfdChallengesCache;

            if (searchTerm) {
                filtered = filtered.filter(c =>
                    c.name.toLowerCase().includes(searchTerm)
                );
            }

            if (categoryFilter) {
                filtered = filtered.filter(c => c.category === categoryFilter);
            }

            // Stats
            const mapped = ctfdChallengesCache.filter(c => c.mapped_local_id).length;
            const suggested = ctfdChallengesCache.filter(c => c.suggested_local_id).length;
            statsContainer.innerHTML = `
                <strong>${ctfdChallengesCache.length}</strong> CTFd challenges | 
                <span style="color: var(--accent-success);">${mapped} mapped</span> | 
                <span style="color: var(--accent-warning);">${suggested} suggested</span>
            `;

            if (filtered.length === 0) {
                listContainer.innerHTML = '<div class="empty-state">No matching challenges found</div>';
                return;
            }

            // Sort: suggested first, then unmapped, then mapped
            filtered.sort((a, b) => {
                if (a.suggested_local_id && !b.suggested_local_id) return -1;
                if (!a.suggested_local_id && b.suggested_local_id) return 1;
                if (!a.mapped_local_id && b.mapped_local_id) return -1;
                if (a.mapped_local_id && !b.mapped_local_id) return 1;
                return a.name.localeCompare(b.name);
            });

            listContainer.innerHTML = filtered.map(c => {
                const isMapped = !!c.mapped_local_id;
                const isSuggested = !!c.suggested_local_id;

                let itemClass = 'ctfd-challenge-item';
                if (isMapped) itemClass += ' mapped';
                else if (isSuggested) itemClass += ' suggested';

                // Build local challenge options
                const localOptions = localChallengesCache.map(lc =>
                    `<option value="${escapeHtml(lc.id)}" ${c.suggested_local_id === lc.id ? 'selected' : ''}>
                        ${escapeHtml(lc.id)}
                    </option>`
                ).join('');

                return `
                    <div class="${itemClass}">
                        <div class="ctfd-challenge-info">
                            <div class="ctfd-challenge-name">
                                ${escapeHtml(c.name)}
                                ${isSuggested ? '<span class="ctfd-challenge-badge warning">‚ö° Match Found</span>' : ''}
                                ${isMapped ? '<span class="ctfd-challenge-badge success">‚úì Mapped</span>' : ''}
                            </div>
                            <div class="ctfd-challenge-meta">
                                CTFd #${c.id} ¬∑ ${escapeHtml(c.category || 'No category')} ¬∑ ${c.value} pts
                                ${isMapped ? ` ¬∑ Mapped to: <strong>${escapeHtml(c.mapped_local_id)}</strong>` : ''}
                            </div>
                        </div>
                        ${!isMapped ? `
                            <select class="sync-action-select" id="sync-select-${c.id}" style="padding: 6px 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary);">
                                <option value="">-- Select Local --</option>
                                ${localOptions}
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="mapFromWizard(${c.id}, '${escapeHtml(c.name)}')">
                                Map
                            </button>
                        ` : `
                            <button class="btn btn-danger btn-sm" onclick="unmapFromWizard('${escapeHtml(c.mapped_local_id)}', ${c.id})">
                                Unmap
                            </button>
                        `}
                    </div>
                `;
            }).join('');
        }

        async function mapFromWizard(ctfdId, ctfdName) {
            const select = document.getElementById(`sync-select-${ctfdId}`);
            const localId = select?.value;

            if (!localId) {
                showToast('Please select a local challenge', 'error');
                return;
            }

            try {
                const params = new URLSearchParams({
                    local_challenge_id: localId,
                    ctfd_challenge_id: ctfdId.toString()
                });

                const res = await fetch(`/admin/api/flags/sync-challenge?${params}`, {
                    method: 'POST',
                    headers: { 'X-Admin-Key': adminKey }
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Failed to map');
                }

                showToast(`Mapped "${localId}" ‚Üí "${ctfdName}" (#${ctfdId})`, 'success');

                // Refresh both wizard and main list
                await Promise.all([fetchCtfdChallenges(), loadFlagsData()]);

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function unmapFromWizard(localId, ctfdId) {
            if (!confirm(`Remove mapping for "${localId}"?`)) return;

            try {
                const res = await fetch(`/admin/api/flags/mapping/${encodeURIComponent(localId)}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Key': adminKey }
                });

                if (!res.ok) {
                    throw new Error('Failed to unmap');
                }

                showToast(`Removed mapping for ${localId}`, 'success');
                await Promise.all([fetchCtfdChallenges(), loadFlagsData()]);

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // =============================================================================
        // Monitoring Functions
        // =============================================================================
        
        let allMonitoringInstances = [];
        
        async function loadMonitoringData() {
            try {
                // Load system metrics and instance metrics in parallel
                const [systemData, instancesData] = await Promise.all([
                    adminApi('/admin/api/monitoring/system'),
                    adminApi('/admin/api/monitoring/instances')
                ]);
                
                // Update system stats
                document.getElementById('stat-total-containers').textContent = systemData.total_containers;
                document.getElementById('stat-running-containers').textContent = systemData.running_containers;
                document.getElementById('stat-total-cpu').textContent = systemData.total_cpu_percent.toFixed(2) + '%';
                document.getElementById('stat-cpu-cores').textContent = systemData.host_cpu_cores + ' cores available';
                document.getElementById('stat-total-memory').textContent = systemData.total_memory_mb.toFixed(0) + ' MB';
                
                const memPercent = systemData.host_memory_total_mb > 0 
                    ? ((systemData.host_memory_used_mb / systemData.host_memory_total_mb) * 100).toFixed(1)
                    : '0';
                document.getElementById('stat-host-memory').textContent = 
                    `${systemData.host_memory_used_mb.toFixed(0)} / ${systemData.host_memory_total_mb.toFixed(0)} MB (${memPercent}%)`;
                
                // Store and render instances
                allMonitoringInstances = instancesData.instances || [];
                renderMonitoringInstances();
                
            } catch (error) {
                console.error('Failed to load monitoring data:', error);
                showToast('Failed to load monitoring data', 'error');
            }
        }
        
        function filterMonitoringInstances() {
            renderMonitoringInstances();
        }
        
        function renderMonitoringInstances() {
            const container = document.getElementById('monitoring-instances-container');
            const showHighUsageOnly = document.getElementById('filter-high-usage').checked;
            
            let instances = allMonitoringInstances;
            
            // Filter high usage if checkbox is checked
            if (showHighUsageOnly) {
                instances = instances.filter(inst => {
                    const highCpu = inst.total_cpu_percent > 50;
                    const highMemory = inst.containers.some(c => c.memory_percent > 80);
                    return highCpu || highMemory;
                });
            }
            
            if (instances.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--text-muted);">No instances found</p>';
                return;
            }
            
            // Sort by CPU usage (highest first)
            instances.sort((a, b) => b.total_cpu_percent - a.total_cpu_percent);
            
            const html = instances.map(inst => {
                const cpuClass = inst.total_cpu_percent > 80 ? 'danger' : inst.total_cpu_percent > 50 ? 'warning' : 'success';
                const avgMemPercent = inst.containers.reduce((sum, c) => sum + c.memory_percent, 0) / inst.containers.length;
                const memClass = avgMemPercent > 80 ? 'danger' : avgMemPercent > 60 ? 'warning' : 'success';
                
                const containersHtml = inst.containers.map(c => {
                    const containerCpuClass = c.cpu_percent > 80 ? 'danger' : c.cpu_percent > 50 ? 'warning' : 'success';
                    const containerMemClass = c.memory_percent > 80 ? 'danger' : c.memory_percent > 60 ? 'warning' : 'success';
                    
                    return `
                        <div style="margin-left: 1.5rem; padding: 0.5rem; border-left: 2px solid var(--border-color); margin-top: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="font-size: 0.85rem;">${escapeHtml(c.container_name)}</strong>
                                    <code style="font-size: 0.7rem; margin-left: 0.5rem; color: var(--text-muted);">${c.container_id}</code>
                                </div>
                                <div style="display: flex; gap: 1rem; font-size: 0.85rem;">
                                    <span class="forensics-type ${containerCpuClass}">CPU: ${c.cpu_percent.toFixed(1)}%</span>
                                    <span class="forensics-type ${containerMemClass}">RAM: ${c.memory_usage_mb.toFixed(0)} MB (${c.memory_percent.toFixed(1)}%)</span>
                                    <span style="color: var(--text-muted);">PIDs: ${c.pids}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="card" style="margin-bottom: 1rem;">
                        <div class="card-body" style="padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="margin: 0; font-size: 1.1rem;">${escapeHtml(inst.challenge_name)}</h3>
                                    <p style="margin: 0.25rem 0 0 0; color: var(--text-muted); font-size: 0.85rem;">
                                        Owner: ${escapeHtml(inst.owner_name)} | Instance: ${escapeHtml(inst.instance_id)}
                                    </p>
                                </div>
                                <div style="text-align: right;">
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Total CPU</div>
                                            <span class="forensics-type ${cpuClass}" style="font-size: 1.2rem; font-weight: bold;">
                                                ${inst.total_cpu_percent.toFixed(1)}%
                                            </span>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Total RAM</div>
                                            <span class="forensics-type ${memClass}" style="font-size: 1.2rem; font-weight: bold;">
                                                ${inst.total_memory_mb.toFixed(0)} MB
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <details style="margin-top: 0.5rem;">
                                <summary style="cursor: pointer; color: var(--accent-primary); font-size: 0.9rem; user-select: none;">
                                    üì¶ ${inst.container_count} Container(s) - Click to expand
                                </summary>
                                <div style="margin-top: 0.5rem;">
                                    ${containersHtml}
                                </div>
                            </details>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        async function refreshMonitoring() {
            showToast('Refreshing metrics...', 'info');
            await loadMonitoringData();
            showToast('Metrics refreshed', 'success');
        }
        
        // =============================================================================
        // Challenge Manager Functions
        // =============================================================================

        async function loadChallengesList() {
            const container = document.getElementById('challenges-list-admin');

            try {
                const data = await adminApi('/admin/api/challenges/list');
                const challenges = data.challenges || [];

                if (challenges.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span class="empty-icon">üì¶</span>
                            <p>No challenges found</p>
                            <p class="empty-hint">Upload a .zip file above to add a challenge</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = challenges.map(ch => {
                    let status = '';
                    let statusColor = 'var(--accent-warning)';

                    if (!ch.has_config) {
                        status = '‚ùå Missing challenge.yaml';
                        statusColor = 'var(--accent-danger)';
                    } else if (!ch.has_compose) {
                        status = '‚ùå Missing docker-compose.yaml';
                        statusColor = 'var(--accent-danger)';
                    } else if (ch.loaded) {
                        status = '‚úÖ Loaded';
                        statusColor = 'var(--accent-success)';
                    } else {
                        status = '‚ö†Ô∏è Not loaded (click Reload)';
                        statusColor = 'var(--accent-warning)';
                    }

                    return `
                        <div class="challenge-admin-card ${selectedChallenge === ch.id ? 'selected' : ''}" data-id="${ch.id}">
                            <div>
                                <strong>${escapeHtml(ch.id)}</strong>
                                <span style="margin-left: 10px; font-size: 0.8rem; color: ${statusColor}">
                                    ${status}
                                </span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-primary btn-sm" onclick="selectChallenge('${ch.id}')">
                                    üìù Edit Files
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="reloadChallenge('${ch.id}')">
                                    üîÑ Reload
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteChallenge('${ch.id}')">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                container.innerHTML = '<div class="empty-state">Failed to load challenges</div>';
            }
        }

        function uploadChallenge(input) {
            if (input.files.length > 0) {
                uploadChallengeFile(input.files[0]);
            }
        }

        async function uploadChallengeFile(file) {
            if (!file.name.endsWith('.zip')) {
                showToast('Only .zip files are allowed', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            showToast('Uploading challenge...', 'info');

            try {
                const response = await fetch('/admin/api/challenges/upload', {
                    method: 'POST',
                    headers: {
                        'X-Admin-Key': adminKey
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast(data.message, 'success');
                    await loadChallengesList();
                    selectChallenge(data.challenge_id);
                } else {
                    showToast(data.detail || data.message || 'Upload failed', 'error');
                }
            } catch (error) {
                showToast('Failed to upload challenge', 'error');
            }

            // Reset file input
            document.getElementById('challenge-file').value = '';
        }

        async function deleteChallenge(challengeId) {
            if (!confirm(`Delete challenge "${challengeId}"? This cannot be undone!`)) return;

            try {
                const response = await fetch(`/admin/api/challenges/${challengeId}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Key': adminKey }
                });

                if (response.ok) {
                    showToast('Challenge deleted', 'success');
                    if (selectedChallenge === challengeId) {
                        selectedChallenge = null;
                        document.getElementById('file-browser-section').classList.add('hidden');
                    }
                    await loadChallengesList();
                } else {
                    const data = await response.json();
                    showToast(data.detail || 'Failed to delete', 'error');
                }
            } catch (error) {
                showToast('Failed to delete challenge', 'error');
            }
        }

        async function reloadChallenge(challengeId) {
            try {
                const response = await fetch(`/admin/api/challenges/${challengeId}/reload`, {
                    method: 'POST',
                    headers: { 'X-Admin-Key': adminKey }
                });
                const data = await response.json();
                showToast(data.message, data.success ? 'success' : 'error');
                await loadChallengesList();
            } catch (error) {
                showToast('Failed to reload challenge', 'error');
            }
        }

        function closeFileEditor() {
            if (unsavedChanges && !confirm('You have unsaved changes. Discard them?')) {
                return;
            }

            selectedChallenge = null;
            selectedFile = null;
            unsavedChanges = false;

            document.getElementById('file-browser-section').classList.add('hidden');

            // Remove selected state from all cards
            document.querySelectorAll('.challenge-admin-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        async function selectChallenge(challengeId) {
            if (unsavedChanges && !confirm('You have unsaved changes. Discard them?')) {
                return;
            }

            selectedChallenge = challengeId;
            selectedFile = null;
            unsavedChanges = false;

            document.getElementById('selected-challenge-name').textContent = challengeId;
            document.getElementById('file-browser-section').classList.remove('hidden');
            document.getElementById('new-file-path').value = '';

            // Update selected state in list
            document.querySelectorAll('.challenge-admin-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.id === challengeId);
            });

            await loadFileTree();

            // Reset editor
            document.getElementById('editor-container').innerHTML = `
                <div class="editor-placeholder">
                    <p>‚Üê Select a file to edit</p>
                </div>
            `;
        }

        async function loadFileTree() {
            const container = document.getElementById('file-tree');

            try {
                const data = await adminApi(`/admin/api/challenges/${selectedChallenge}/files`);
                container.innerHTML = renderFileTree(data.files);
            } catch (error) {
                container.innerHTML = '<div class="empty-state">Failed to load files</div>';
            }
        }

        function renderFileTree(items, depth = 0) {
            return items.map(item => {
                const icon = item.type === 'directory' ? 'üìÅ' : getFileIcon(item.name);
                const clickHandler = item.type === 'directory'
                    ? `onclick="toggleFolder(this)"`
                    : (item.editable
                        ? `onclick="openFile('${escapeHtml(item.path)}')"`
                        : `onclick="showToast('Cannot edit binary file', 'error')"`);

                let html = `
                    <div class="file-tree-item ${item.editable === false ? 'disabled' : ''}" 
                         data-path="${escapeHtml(item.path)}" 
                         data-type="${item.type}"
                         ${clickHandler}>
                        <span class="icon">${icon}</span>
                        <span>${escapeHtml(item.name)}</span>
                    </div>
                `;

                if (item.type === 'directory' && item.children) {
                    html += `<div class="file-tree-children">${renderFileTree(item.children, depth + 1)}</div>`;
                }

                return html;
            }).join('');
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'py': 'üêç', 'js': 'üìú', 'ts': 'üìò', 'html': 'üåê', 'css': 'üé®',
                'yaml': '‚öôÔ∏è', 'yml': '‚öôÔ∏è', 'json': 'üìã', 'md': 'üìù', 'txt': 'üìÑ',
                'sh': 'üíª', 'dockerfile': 'üê≥', 'sql': 'üóÉÔ∏è', 'c': '‚ö°', 'cpp': '‚ö°',
                'go': 'üîµ', 'rs': 'ü¶Ä', 'php': 'üêò', 'rb': 'üíé', 'java': '‚òï'
            };
            return icons[ext] || 'üìÑ';
        }

        function toggleFolder(element) {
            const children = element.nextElementSibling;
            if (children && children.classList.contains('file-tree-children')) {
                children.style.display = children.style.display === 'none' ? 'block' : 'none';
                const icon = element.querySelector('.icon');
                icon.textContent = children.style.display === 'none' ? 'üìÅ' : 'üìÇ';
            }
        }

        async function openFile(filePath) {
            if (unsavedChanges && !confirm('You have unsaved changes. Discard them?')) {
                return;
            }

            try {
                const data = await adminApi(`/admin/api/challenges/${selectedChallenge}/files/${filePath}`);
                selectedFile = filePath;
                unsavedChanges = false;

                // Update selected state
                document.querySelectorAll('.file-tree-item').forEach(item => {
                    item.classList.toggle('selected', item.dataset.path === filePath);
                });

                // Show editor
                document.getElementById('editor-container').innerHTML = `
                    <div class="editor-toolbar">
                        <span class="editor-path">${escapeHtml(filePath)}</span>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary btn-sm" onclick="saveFile()">
                                üíæ Save
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteFile('${escapeHtml(filePath)}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                    <textarea class="file-editor" id="file-content" onchange="unsavedChanges=true" oninput="unsavedChanges=true">${escapeHtml(data.content)}</textarea>
                `;

            } catch (error) {
                showToast('Failed to open file', 'error');
            }
        }

        async function saveFile() {
            if (!selectedFile) return;

            const content = document.getElementById('file-content').value;

            try {
                const response = await fetch(`/admin/api/challenges/${selectedChallenge}/files/${selectedFile}`, {
                    method: 'PUT',
                    headers: {
                        'X-Admin-Key': adminKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast('File saved!', 'success');
                    unsavedChanges = false;

                    // Reload challenge list if config file
                    if (selectedFile.includes('challenge.yaml') || selectedFile.includes('challenge.yml')) {
                        await loadChallengesList();
                    }
                } else {
                    showToast(data.detail || 'Failed to save', 'error');
                }
            } catch (error) {
                showToast('Failed to save file', 'error');
            }
        }

        async function createNewFile() {
            const filePath = document.getElementById('new-file-path').value.trim();
            if (!filePath) {
                showToast('Enter a file path', 'error');
                return;
            }

            try {
                const response = await fetch(`/admin/api/challenges/${selectedChallenge}/files/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'X-Admin-Key': adminKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content: '' })
                });

                if (response.ok) {
                    showToast('File created!', 'success');
                    document.getElementById('new-file-path').value = '';
                    await loadFileTree();
                    openFile(filePath);
                } else {
                    const data = await response.json();
                    showToast(data.detail || 'Failed to create file', 'error');
                }
            } catch (error) {
                showToast('Failed to create file', 'error');
            }
        }

        async function deleteFile(filePath) {
            if (!confirm(`Delete "${filePath}"?`)) return;

            try {
                const response = await fetch(`/admin/api/challenges/${selectedChallenge}/files/${filePath}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Key': adminKey }
                });

                if (response.ok) {
                    showToast('File deleted', 'success');
                    selectedFile = null;
                    unsavedChanges = false;
                    await loadFileTree();

                    document.getElementById('editor-container').innerHTML = `
                        <div class="editor-placeholder">
                            <p>‚Üê Select a file to edit</p>
                        </div>
                    `;
                } else {
                    const data = await response.json();
                    showToast(data.detail || 'Failed to delete', 'error');
                }
            } catch (error) {
                showToast('Failed to delete file', 'error');
            }
        }

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (unsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>

    <!-- CTFd Sync Wizard Modal -->
    <div class="modal-overlay" id="sync-wizard-modal" onclick="closeSyncWizard(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üîÑ CTFd Sync Wizard</h3>
                <button class="modal-close" onclick="closeSyncWizard()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 16px;">
                    Fetch challenges from CTFd and map them to your local challenges.
                    <span style="color: var(--accent-warning);">‚ö° Suggested</span> matches are highlighted.
                </p>

                <div class="sync-filters">
                    <input type="text" id="sync-search" placeholder="Search by name..."
                        oninput="filterSyncChallenges()">
                    <select id="sync-category" onchange="filterSyncChallenges()">
                        <option value="">All Categories</option>
                    </select>
                    <button class="btn btn-secondary btn-sm" onclick="fetchCtfdChallenges()">
                        <span class="btn-icon">üîÑ</span> Refresh
                    </button>
                </div>

                <div id="sync-stats" style="margin-bottom: 12px; font-size: 0.85rem; color: var(--text-muted);"></div>

                <div class="ctfd-challenge-list" id="ctfd-challenge-list">
                    <div class="loading">Click "Refresh" to fetch challenges from CTFd...</div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>